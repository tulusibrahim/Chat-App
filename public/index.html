<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>Document</title>
</head>

<body>
    <div id="content">
        <div id="msg"></div>
        <form action="" id="sendmsg">
            <input type="text" placeholder="Enter message" id="msgvalue">
            <button id="btnsend" type="submit">Send</button>
        </form>
        <div id="usertype"></div>
    </div>
</body>
<script>
    'use strict';
    //biar bisa diakses dr device lain ganti localhost sm current ip
    //let socket = io.connect('http://' + '192.168.100.5' + ':3001')
    let socket = io()
    let btnsend = document.getElementById('btnsend')
    let msgfield = document.getElementById('msg')
    let isipesan = document.getElementById('msgvalue')
    let roomname = document.getElementById('roomname')
    let btnroom = document.getElementById('btnroom')
    let usertype = document.getElementById('usertype')


    //ask the user to get their name
    let name = prompt("whats your name?")
    incoming("You joined")

    //send the name to the server
    socket.emit('newuser', name)

    //handle the username that just join to display it in the client
    socket.on('newuserconnected', function (result) {
        incoming(result + " just joined")
        msgfield.scrollTop = msgfield.scrollHeight;
    })

    function incoming(namepeople) {
        let usernew = document.createElement('div')
        usernew.classList.add('neww')
        usernew.style.display = 'flex'
        usernew.style.justifyContent = 'center'
        usernew.innerText = namepeople
        msgfield.append(usernew)
    }

    //handle the user that just leave from the server to display it in client
    socket.on('userleave', function (result) {
        leave(result + " just leave")
        msgfield.scrollTop = msgfield.scrollHeight;
    })
    function leave(namepeople) {
        let userleave = document.createElement('div')
        userleave.classList.add('leave')
        userleave.style.display = 'flex'
        userleave.style.justifyContent = 'center'
        userleave.innerText = namepeople
        msgfield.append(userleave)
    }

    //let the other know that someone is typing
    isipesan.addEventListener('keyup', function () {
        if (isipesan.value.length == 0) {
            socket.emit('noTyping')
        }
        else if (isipesan.value.length > 0) {
            socket.emit('typing', name)
        }
    })

    //handle if someone gajadi ngetik/isipesan.value nya 0
    socket.on('zerotype', function () {
        usertype.innerText = ''
        msgfield.scrollTop = msgfield.scrollHeight;
    })

    //handle 'the someone is typing' from server
    socket.on('usertyping', function (result) {
        usertype.innerText = result + " is typing..."
        msgfield.scrollTop = msgfield.scrollHeight;
    })

    //send the msg to the server and server will handle it
    btnsend.addEventListener('click', function (e) {
        e.preventDefault()
        let date = new Date()
        let mnt = date.getMinutes() < 10 ? `0${date.getMinutes()}` : `${date.getMinutes()}`
        socket.emit('msg', isipesan.value)
        addingmyself(`You: ${isipesan.value}      ${date.getHours()}:${mnt}`)
        isipesan.value = ''
        msgfield.scrollTop = msgfield.scrollHeight;
    })

    function addingmyself(message) {
        let addnewmsg = document.createElement('div')
        addnewmsg.classList.add('newmsgmyself')
        addnewmsg.innerText = message
        msgfield.append(addnewmsg)
    }

    //common function to create new element
    function adding(message) {
        let addnewmsg = document.createElement('div')
        addnewmsg.classList.add('newmsg')
        addnewmsg.innerText = message
        msgfield.append(addnewmsg)
    }

    //handle the message that just spread from the server
    socket.on('newmsg', function (result) {
        adding(`${result.name}: ${result.message}   ${result.hour}:${result.minute}`)
        msgfield.scrollTop = msgfield.scrollHeight;
    })

</script>
<style>
    #usertype {
        text-align: center;
    }

    .newmsgmyself {
        width: 90%;
        height: 20px;
        background-color: rgb(110, 122, 110);
        display: flex;
        justify-content: flex-end;
    }

    .neww {
        width: 90%;
        height: 20px;
        color: green;
        font-weight: 500;
    }

    .leave {
        width: 90%;
        height: 20px;
        color: red
    }

    .newmsg {
        width: 90%;
        height: 20px;
        background-color: rgb(157, 161, 157);
        border: none;
    }

    #btnsend {
        width: 25%;
        height: 100%;
    }

    #msgvalue {
        width: 90%;
        height: 100%;
    }

    #sendmsg {
        width: 100%;
        height: 8vh;
        display: flex;
        align-items: center;
        position: fixed;
        justify-content: center;
        bottom: 0;
        position: fixed;
    }

    #msg {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        flex-direction: column;
        max-height: 90vh;
        width: 100%;
        overflow-y: auto;
    }


    #content {
        width: 100%;
        height: 100%;
    }

    * {
        margin: 0;
        padding: 0;
    }
</style>

</html>